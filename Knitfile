local knit = import("knit")

local chisel = require "build/chisel"

top = cli.top or "Soc"
sbt := sbt --client
src = knit.rglob("src/main/scala/", "*.scala")
gen := generated
prog = cli.prog or "blink"
mem = f"sw/$prog/$prog.mem"

local build = chisel.build(src, sbt, "rtor", top, gen, mem)
local format = chisel.format(sbt, gen)

local verilator = require "build/verilator"

local verilogCore = f"$gen/Core/*.sv"
local subtests = include("tests/Knitfile")
local test = verilator.build("tests/tb.cc", verilogCore, "Core", f"$gen/Core/Core.sv [$subtests][tests]hdr")

local rules = r(
    {
        $ build:V: $gen/$top/$top.sv
    },
    build,
    format,
    test
)

local verilog = f"$gen/$top/*.sv $gen/$top/generated/*.sv"

local tech = cli.tech or ""
if tech == "orangecrab" then
    local oc = require "build/orangecrab"
    rules = r(rules.Rules, oc.build(
        "tech/orangecrab/orangecrab.lpf",
        knit.glob("tech/orangecrab/*.v"),
        top,
        f"$gen/$top/*.sv $gen/$top/generated/*.sv",
        f"$gen/$top/$top.sv",
        tobool(cli.quiet or true)
    ))
end

local sw = require "build/sw"
local swrules = sw.build(prog)

rules = r(rules.Rules, swrules.Rules)

return rules
